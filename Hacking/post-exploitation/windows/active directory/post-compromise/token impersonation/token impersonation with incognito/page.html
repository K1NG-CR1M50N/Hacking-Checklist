<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Token Impersonation with Incognito</title>
</head><body><b><u><div style="text-align: center"><span style="font-size: 20pt">Token Impersonation with Incognito</span></div></u></b><br/>
<br/>
<br/>
<br/>
<span style="font-size: 15pt">First, we need to get a shell on the enemy side:<br/>
We will use Metasploit, with <b>psexec<br/>
</b></span><img src="1.png" /><br/>
<span style="font-size: 15pt"><b><br/>
</b></span><img src="2.png" /><br/>
<span style="font-size: 15pt"><b><br/>
</b></span><img src="3.png" /><br/>
<span style="font-size: 15pt"><b><br/>
</b></span><img src="4.png" /><br/>
<br/>
<br/>
<br/>
<br/>
<span style="font-size: 15pt">As a payload, we want to set a meterpreter (to use <b>incognito</b>)<br/>
</span><img src="1 2.png" /><br/>
<img src="1 3.png" /><br/>
<br/>
<br/>
<br/>
<span style="font-size: 15pt"><b>Run the exploit: (I had to use the PoweShell target, due to a problem but doesn't change the attack)</b></span><br/>
<br/>
<br/>
<span style="font-size: 15pt">This time, we will load the incognito feature:</span><br/>
<img src="1 5.png" /><br/>
<img src="2 2.png" /><br/>
<br/>
<br/>
<span style="font-size: 15pt">We want to list all the tokens for the users (-u)<br/>
</span><img src="1 6.png" /><br/>
<br/>
<br/>
<br/>
<span style="font-size: 15pt">Here, we can use the delegation token for <b>MARVEL\Administrator</b><br/>
</span><img src="1 7.png" /><br/>
<br/>
<br/>
<br/>
<span style="font-size: 15pt">Infact, if we create a shell and check for the user, we are</span>&nbsp;<span style="font-size: 15pt"><b>MARVEL\Administrator<br/>
</b></span><img src="1 8.png" /><b><span style="font-size: 15pt"><br/>
</span></b><b><span style="font-size: 15pt"><br/>
<br/>
</span></b><span style="font-size: 15pt">If we quit the shell and try to <b>"hashdump"</b>&nbsp;for the SAM in meterpreter, we will get an error:<br/>
</span><img src="1 4.png" /><span style="font-size: 15pt"><br/>
</span><span style="font-size: 15pt"><br/>
<br/>
But if we get to our old "self" (with <b>rev2self</b>&nbsp;command), we can dump it!!<br/>
</span><img src="2 3.png" /><br/>
<br/>
<br/>
<br/>
<span style="font-size: 15pt">Remember: The Delegation Tokens exist until someone is logged!!!<br/>
If someone log, create a Kerberos Delegation Token</span></body></html>